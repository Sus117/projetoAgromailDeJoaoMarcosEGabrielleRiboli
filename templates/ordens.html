{% extends 'base.html' %}
{% block title %}Abrir Ordem de Serviço — Ordens de Serviço{% endblock %}
{% block content %}

<style>
/* PADRONIZAÇÃO VISUAL ENTRE BOTÃO E LINK */
  .btn-padrao {
    display: block;              /* garante empilhamento */
    width: 420px;                /* mesma largura dos dois */
    padding: 12px 0;             /* altura idêntica */
    margin: 10px auto;           /* centraliza e separa */
    font-size: 15px;
    font-weight: bold;
    border-radius: 8px;
    border: 4px solid;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    transition: 0.15s;
}

/* CONTÊINER CENTRALIZADO */
.center-container,
.form-actions {
    width: 100%;
    display: flex;
    justify-content: center;
}
</style>


<!-- BARRA ENTRE NAVBAR E O CONTEÚDO -->
<div class="barra"
     style="
       width: 81%;
       background-color: #F0FFF0;
       border: 3px solid #cc6600;
       border-radius: 8px;
       padding: 10px;
       display: flex;
       justify-content: center;
       gap: 20px;
       margin-bottom: 15px;
       margin-top: 15px;
       margin-left: auto;          /* centraliza */
       margin-right: auto;         /* centraliza */
     ">

       <!-- ÍCONE DE MENU (lado esquerdo) -->
  <a href="{{ url_for('index') }}" 
   id="menu-icon"
   title="Este botão retorna a tela primária"
   style="
     display: inline-block;
     background-color: transparent;
     border: none;
     font-size: 35px;
     color: #cc6600;
     text-decoration: none;
     margin-left: 25px;
     cursor: pointer;
     transition: 0.2s;
     font-weight: bold;
   "
   onmouseover="this.style.color = document.body.classList.contains('dark-mode') ? '#cc6600' : '##cc6600'"
   onmouseout="this.style.color = document.body.classList.contains('dark-mode') ? '#fff' : '#cc6600'">
  <i class="fa fa-bars"></i>
</a>

  <!-- BOTÃO 1 -->
  <a href="{{ url_for('ordens') }}" class="botao"
  tittle = "Clique para ir á página de abertura de ordens"
     style="
       display: inline-block;
       background-color: #ccff33;
       border: 3px solid #cc6600;
       padding: 10px 20px;
       font-size: 19px;
       border-radius: 8px;
       text-decoration: none;
       color: #cc6600;
       transition: 0.2s;
     ">
    Abrir Ordens De Serviço
  </a>

  <!-- BOTÃO 2 -->
  <a href="{{ url_for('ordens_minhas') }}" class="botao"
  tittle = "Clique para vizualizar as ordens recentemente criadas por você"
     style="
       display: inline-block;
       background-color: #ccff33;
       border: 3px solid #cc6600;
       padding: 10px 20px;
       font-size: 19px;
       border-radius: 8px;
       text-decoration: none;
       color: #cc6600;
       transition: 0.2s;
     ">
    Vizualizar Minhas Próprias Ordens
  </a>

</div>

<section class="card">
  <h1>Abrir Ordem de Serviço</h1>
  <form class="form" method="post" action="{{ url_for('ordens') }}">
    <div class="form-row">
      <label for="cultivar_id">Cultivar (semente)</label>
      <select id="cultivar_id" name="cultivar_id" required>
        <option value="">Selecione...</option>
        {% for c in cultivares %}
          <option value="{{ c.id }}">{{ c.nome }}{% if c.especie %} - {{ c.especie }}{% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-row">
      <label for="quantidade">Número de sementes</label>
      <input type="number" id="quantidade" name="quantidade" min="1" required />
    </div>
    

    <div class="form-row">
  <label for="observacoes">Observações</label>
  <textarea 
    id="observacoes" 
    name="observacoes" 
    rows="3"
    style="
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      /* BORDAS FIXAS - mais simples */
      border: 2.75px solid #CC6600;
      background-color: transparent;
    "
    onfocus="
      this.style.outline = 'none';
      this.style.boxShadow = '0 0 0 2px rgba(204, 102, 0, 0.3)';
    "
    onblur="
      this.style.boxShadow = 'none';
    "
  ></textarea>
  <!-- Script para ajustar borda conforme tema -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('observacoes');
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            if (document.body.classList.contains('dark-mode')) {
              textarea.style.borderColor = '#ddd9ce';
            } else {
              textarea.style.borderColor = '#CC6600';
            }
          }
        });
      });
      
      observer.observe(document.body, { attributes: true });
      
      // Define cor inicial
      if (document.body.classList.contains('dark-mode')) {
        textarea.style.borderColor = '#ddd9ce';
      }
    });
  </script>
</div>

    <div class="form-row">
      <label for="data_entrega">Data de entrega</label>
      <input type="date" id="data_entrega" name="data_entrega" />
    </div>
    <div class="form-row">
    <label for="sla">SLA (Urgência Pela Conclusão)</label>
    <select id="sla" name="sla">
        <option value="">Selecione...</option>
        <option value="muito_baixo">Muito Baixo</option>
        <option value="baixo">Baixo</option>
        <option value="medio">Médio</option>
        <option value="alto">Alto</option>
        <option value="muito_alto">Muito Alto</option>
    </select>

  </div>
    </div>
    <button type="submit" class="button btn-padrao" id="btnAbrirOrdem" 
        style="white-space: nowrap; width: 100%;">
    Abrir Ordem
</button>



</div>


<!-- MODAL PARA ABRIR ORDEM -->
<div id="modalAbrirOrdem" style="
     display: none;
     border-width: 4px;  
     position: fixed;
     top: 0; left: 0;
     width: 100vw;      /* 100% da largura da viewport */
     height: 100vh;     /* 100% da altura da viewport */
     background: rgba(0,0,0,0.5);
     justify-content: center;
     align-items: center;
     text-align: center;
     z-index: 9999;
  ">
  <div id="modalContentOrdem" style="
       background: #fff;
       border-radius: 8px;
       border: 2.5px solid #cc6600;
       width: 440px;
       text-align: center;
  ">
    <h3 style="margin-bottom:10px;">Confirmar ação</h3>
    <p style="margin-bottom:14px;">Você realmente quer abrir esta ordem?</p>

    <div style="display:flex; justify-content:space-around;">
      <button type="button" id="cancelAbrirOrdem" style="
          padding:6px 14px;
          border-radius:4px;
          cursor:pointer;
        ">Cancelar</button>

      <button type="button" id="confirmAbrirOrdem" style="
          padding:6px 14px;
          border-radius:4px;
          cursor:pointer;
          font-weight:bold;
        ">Abrir</button>
    </div>
  </div>
</div>

<script>
(function(){
  // CORES
  const cores = {
    pardo:  '#CC6600',
    verde:  '#CCFF33',
    branco: '#FFFFFF',
    roxo:   '#8e44ad',
    preto:  '#0F1C34'
  };

  // DETECTAR TEMA
  function detectTema() {
    if (localStorage.getItem("theme")) return localStorage.getItem("theme");
    if (document.documentElement.dataset.theme) return document.documentElement.dataset.theme;
    if (document.body.classList.contains("dark-mode")) return "dark";
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }

  // APLICAR ESTILOS COM HOVER
  function aplicarHovers() {
    const tema = detectTema();
    
    // BOTÃO "ABRIR ORDEM"
    document.querySelectorAll('.button').forEach(btn => {
      if (btn.textContent.trim() === 'Abrir Ordem') {
        // Remover eventos anteriores
        btn.onmouseenter = null;
        btn.onmouseleave = null;
        
        // Aplicar estilo base igual ao .btn-salvar
        btn.style.padding = '10px 419px';
        btn.style.borderRadius = '6px';
        btn.style.fontSize = '11.8px';
        btn.style.cursor = 'pointer';
        btn.style.fontWeight = 'bold';
        btn.style.transition = '0.15s';
        btn.style.border = '4px solid';
        
        // Estado normal
        if (tema === 'dark') {
          btn.style.background = cores.roxo;
          btn.style.color = cores.branco;
          btn.style.borderColor = cores.branco;
        } else {
          btn.style.background = cores.verde;
          btn.style.color = cores.pardo;
          btn.style.borderColor = cores.pardo;
        }
        
        // Hover
        btn.addEventListener('mouseenter', function() {
          if (tema === 'dark') {
            this.style.background = cores.verde;
            this.style.color = cores.pardo;
            this.style.borderColor = cores.pardo;
          } else {
            this.style.background = cores.roxo;
            this.style.color = cores.branco;
            this.style.borderColor = cores.pardo;
          }
        });
        
        btn.addEventListener('mouseleave', function() {
          aplicarHovers();
        });
      }
    });
    
    // MODAL ABRIR ORDEM
    const modalContentOrdem = document.getElementById('modalContentOrdem');
    const cancelBtnOrdem = document.getElementById('cancelAbrirOrdem');
    const confirmBtnOrdem = document.getElementById('confirmAbrirOrdem');
    
    if (modalContentOrdem) {
      if (tema === 'dark') {
        modalContentOrdem.style.background = cores.preto;
        modalContentOrdem.style.color = cores.branco;
        modalContentOrdem.style.borderColor = cores.branco;
      } else {
        modalContentOrdem.style.background = cores.branco;
        modalContentOrdem.style.color = '#000';
        modalContentOrdem.style.borderColor = cores.pardo;
      }
    }
    
    if (cancelBtnOrdem) {
      if (tema === 'dark') {
        cancelBtnOrdem.style.background = '#555';
        cancelBtnOrdem.style.color = '#fff';
        cancelBtnOrdem.style.border = '2px solid #888';
      } else {
        cancelBtnOrdem.style.background = '#ccc';
        cancelBtnOrdem.style.color = '#000';
        cancelBtnOrdem.style.border = '2px solid #777';
      }
      
      // Hover simples para cancelar
      cancelBtnOrdem.onmouseenter = () => cancelBtnOrdem.style.opacity = '0.85';
      cancelBtnOrdem.onmouseleave = () => cancelBtnOrdem.style.opacity = '1';
    }
    
    if (confirmBtnOrdem) {
      // Remover eventos anteriores
      confirmBtnOrdem.onmouseenter = null;
      confirmBtnOrdem.onmouseleave = null;
      
      // Estado normal
      if (tema === 'dark') {
        confirmBtnOrdem.style.background = cores.roxo;
        confirmBtnOrdem.style.color = cores.branco;
        confirmBtnOrdem.style.border = '2px solid ' + cores.branco;
      } else {
        confirmBtnOrdem.style.background = cores.verde;
        confirmBtnOrdem.style.color = cores.pardo;
        confirmBtnOrdem.style.border = '2px solid ' + cores.pardo;
      }
      
      // Hover
      confirmBtnOrdem.addEventListener('mouseenter', function() {
        if (tema === 'dark') {
          this.style.background = cores.verde;
          this.style.color = cores.pardo;
          this.style.borderColor = cores.pardo;
        } else {
          this.style.background = cores.roxo;
          this.style.color = cores.branco;
          this.style.borderColor = cores.pardo;
        }
      });
      
      confirmBtnOrdem.addEventListener('mouseleave', function() {
        aplicarHovers();
      });
    }
  }

  // FUNCIONALIDADE DO MODAL ABRIR ORDEM
  const modalOrdem = document.getElementById('modalAbrirOrdem');
  let formAlvoOrdem = null;

  function abrirModalOrdem(form) {
    formAlvoOrdem = form;
    modalOrdem.style.display = 'flex';
    aplicarHovers();
  }

  function fecharModalOrdem() {
    modalOrdem.style.display = 'none';
    formAlvoOrdem = null;
  }

  // CONFIGURAR EVENTOS
  function configurarEventos() {
    // Botão "Abrir Ordem"
    document.querySelectorAll('.button').forEach(btn => {
      if (btn.textContent.trim() === 'Abrir Ordem') {
        btn.onclick = (e) => {
          e.preventDefault();
          const form = btn.closest('form') || document.querySelector('form');
          abrirModalOrdem(form);
        };
      }
    });
    
    // Botões do modal
    if (document.getElementById('cancelAbrirOrdem')) {
      document.getElementById('cancelAbrirOrdem').onclick = fecharModalOrdem;
    }
    
    if (document.getElementById('confirmAbrirOrdem')) {
      document.getElementById('confirmAbrirOrdem').onclick = () => {
        if (formAlvoOrdem) formAlvoOrdem.submit();
      };
    }
    
    // Fechar modal clicando fora
    if (modalOrdem) {
      modalOrdem.onclick = (e) => {
        if (e.target === modalOrdem) fecharModalOrdem();
      };
    }
  }

  // INICIAR
  function iniciar() {
    aplicarHovers();
    configurarEventos();
  }

  // Quando o DOM carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', iniciar);
  } else {
    iniciar();
  }

  // Observar mudanças de tema
  const observer = new MutationObserver(() => {
    aplicarHovers();
  });
  
  observer.observe(document.documentElement, { 
    attributes: true, 
    attributeFilter: ['class', 'data-theme'] 
  });
  
  observer.observe(document.body, { 
    attributes: true, 
    attributeFilter: ['class'] 
  });

  // Atualizar quando o tema mudar no localStorage
  window.addEventListener('storage', (e) => {
    if (e.key === 'theme') {
      aplicarHovers();
    }
  });

})();
</script>


</div>
</div>
  </form>
  <p class="muted">Informe os dados e clique em Abrir Ordem.</p>
</section>

<!-- SCRIPT: sincroniza barra/botões com o tema e integra com os botões de configuração -->
<script>
(function() {
  // Aplica estilos da barra e botões conforme o estado atual de body.dark-mode
  function applyThemeToBar() {
    const barra = document.querySelector('.barra');
    if (!barra) return;
    const botoes = barra.querySelectorAll('.botao');
    const isDark = document.body.classList.contains('dark-mode');

    if (isDark) {
      barra.style.backgroundColor = '#1D3E5E';
      barra.style.border = '3px solid #fff';
      botoes.forEach(btn => {
        btn.style.backgroundColor = '#8e44ad';
        btn.style.border = '3px solid #fff';
        btn.style.color = '#fff';
        btn.onmouseover = function () {
          this.style.backgroundColor = '#ccff33';
          this.style.color = '#cc6600';
          this.style.borderColor = '#cc6600';
        };
        btn.onmouseout = function () {
          this.style.backgroundColor = '#8e44ad';
          this.style.color = '#fff';
          this.style.borderColor = '#fff';
        };
      });
    } else {
      barra.style.backgroundColor = '#F0FFF0';
      barra.style.border = '3px solid #cc6600';
      botoes.forEach(btn => {
        btn.style.backgroundColor = '#ccff33';
        btn.style.border = '3px solid #cc6600';
        btn.style.color = '#cc6600';
        btn.onmouseover = function () {
          this.style.backgroundColor = '#8e44ad';
          this.style.color = '#fff';
          this.style.borderColor = '#cc6600';
        };
        btn.onmouseout = function () {
          this.style.backgroundColor = '#ccff33';
          this.style.color = '#cc6600';
          this.style.borderColor = '#cc6600';
        };
      });
    }
  }

  // Observa mudanças na classe do body para reagir quando o tema mudar em qualquer parte da app
  const observer = new MutationObserver(() => applyThemeToBar());
  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

  // Integra com os botões de configuração do painel (lightMode/darkMode)
  function waitForSettingsButtons() {
    const light = document.getElementById('lightMode');
    const dark = document.getElementById('darkMode');
    if (light && dark) {
      // Reforça handlers: quando clicados, atualizam body e barra
      light.onclick = function() {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        // Atualiza estado visual dos botões do painel
        light.classList.add('active');
        dark.classList.remove('active');
        applyThemeToBar();
      };
      dark.onclick = function() {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        dark.classList.add('active');
        light.classList.remove('active');
        applyThemeToBar();
      };

      // Aplica tema salvo imediatamente
      const saved = localStorage.getItem('theme') || 'light';
      if (saved === 'dark') {
        document.body.classList.add('dark-mode');
        dark.classList.add('active');
        light.classList.remove('active');
      } else {
        document.body.classList.remove('dark-mode');
        light.classList.add('active');
        dark.classList.remove('active');
      }
      applyThemeToBar();
      return true;
    }
    return false;
  }

  // Tenta encontrar os botões de configuração; se ainda não renderizaram, re-tenta
  function init() {
    if (!waitForSettingsButtons()) {
      const retry = setInterval(() => {
        if (waitForSettingsButtons()) clearInterval(retry);
      }, 150);
      // Fallback: aplica tema salvo mesmo antes dos botões existirem
      const saved = localStorage.getItem('theme') || 'light';
      if (saved === 'dark') document.body.classList.add('dark-mode');
      else document.body.classList.remove('dark-mode');
      applyThemeToBar();
    }
  }

  // Inicializa ao carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

document.addEventListener('DOMContentLoaded', function() {
    const menuIcon = document.getElementById('menu-icon');
    if (document.body.classList.contains('dark-mode')) {
        menuIcon.style.color = '#fff';
    } else {
        menuIcon.style.color = '#cc6600';
    }
    
    // Observa mudanças de tema
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                if (document.body.classList.contains('dark-mode')) {
                    menuIcon.style.color = '#fff';
                } else {
                    menuIcon.style.color = '#cc6600';
                }
            }
        });
    });
    observer.observe(document.body, { attributes: true });
});
</script>

{% endblock %}