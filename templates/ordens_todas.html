{% extends 'base.html' %}

{% block title %}Todas as Ordens — Ordens de Serviço{% endblock %}

{% block content %}
    <!-- BARRA ENTRE NAVBAR E O CONTEÚDO -->
    <!-- BARRA ENTRE NAVBAR E O CONTEÚDO -->
<div class="barra"
     style="
       width: 81%;
       background-color: #F0FFF0;
       border: 3px solid #cc6600;
       border-radius: 8px;
       padding: 10px;
       display: flex;
       align-items: center;
       justify-content: center;
       gap: 20px;
       margin-bottom: 15px;
       margin-top: 15px;
       margin-left: auto;
       margin-right: auto;
     ">

  <!-- ÍCONE DE MENU (lado esquerdo) -->
<a title="Clique neste botão para voltar a tela de seleção" href="{{ url_for('index') }}" 
   id="menu-icon"
   style="
     display: inline-block;
     background-color: transparent;
     border: none;
     font-size: 35px;
     color: #cc6600;
     text-decoration: none;
     margin-left: 25px;
     cursor: pointer;
     transition: 0.2s;
     font-weight: bold;
   "
   onmouseover="this.style.color = document.body.classList.contains('dark-mode') ? '#cc6600' : '#cc6600'"
   onmouseout="this.style.color = document.body.classList.contains('dark-mode') ? '#fff' : '#cc6600'">
  <i class="fa fa-bars"></i>
</a>
  
  <!-- FECHAMENTO DO LINK DO MENU -->

  <!-- BOTÃO 1 -->
  <a title="Clique para ir á página cadastrar cultivares" href="{{ url_for('cultivares') }}" class="botao"
     style="
       display: inline-block;
       background-color: #ccff33;
       border: 3px solid #cc6600;
       padding: 10px 20px;
       font-size: 19px;
       border-radius: 8px;
       text-decoration: none;
       color: #cc6600;
       transition: 0.2s;
     ">
    Cadastrar Cultivares
  </a>

  <!-- BOTÃO 2 -->
  <a title="Clique para ir á página vizualizar ordens de serviços" href="{{ url_for('ordens_todas') }}" class="botao"
     style="
       display: inline-block;
       background-color: #ccff33;
       border: 3px solid #cc6600;
       padding: 10px 20px;
       font-size: 19px;
       border-radius: 8px;
       text-decoration: none;
       color: #cc6600;
       transition: 0.2s;
     ">
    Vizualizar Ordens de Serviços de Todos
  </a>

</div>


    <section class="card">
        <h1>Chamados abertos</h1>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuário</th>
                    <th>Cultivar</th>
                    <th>Quantidade</th>
                    <th>Observações</th>
                    <th>Criada em</th>
                    <th>Resolvido</th>
                </tr>
            </thead>
            <tbody>
                {% if abertos and abertos|length > 0 %}
                    {% for o in abertos %}
                        <tr{% if session.get('user_id') == o.solicitante_id %} class="highlight-self"{% endif %}>
                            <td>{{ o.id }}</td>
                            <td>{{ o.solicitante.username }}</td>
                            <td>{{ o.cultivar.nome }}{% if o.cultivar.especie %} - {{ o.cultivar.especie }}{% endif %}</td>
                            <td>{{ o.quantidade or '-' }}</td>
                            <td>{{ o.descricao or '-' }}</td>
                            <td>{{ o.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                            


    
{% if session.get('role') == 'operador' or session.get('username') == 'adm' %}
<form id="formFinalizar{{ o.id }}" method="post" action="{{ url_for('ordem_finalizar', ordem_id=o.id) }}">

    <button type="button"
        class="btn-finalizar"
        data-ordem-id="{{ o.id }}"
        onclick="abrirModal('{{ o.id }}')"
        style="
          padding: 6px 12px;
          border-radius: 6px;
          font-size: 14px;
          cursor: pointer;
          font-weight: bold;
          transition: 0.15s;
          border: 2px solid;
        ">
      Finalizar
    </button>

</form>
{% endif %}

<!-- MODAL -->
<div id="modalConfirmacao" 
     style="
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
     ">
    
    <div style="
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        border: 3px solid #cc6600;
        width: 280px;
        text-align: center;
     ">
        <h3 style="margin-bottom: 15px; color:#000;">Confirmar ação</h3>
        <p style="margin-bottom: 20px; color:#000;">Você quer realmente finalizar?</p>

        <div style="display: flex; justify-content: space-around;">

            <!-- Cancelar -->
            <button type="button"
                style="
                    padding: 6px 14px;
                    background:#ccc;
                    border: 2px solid #555;
                    border-radius:4px;
                    cursor:pointer;
                "
                onclick="fecharModal()"
            >Cancelar</button>

            <!-- Confirmar -->
            <button id="btnConfirmarModal" type="button"
                style="
                    padding: 6px 14px;
                    background:#ffd966;
                    border: 2px solid #cc6600;
                    border-radius:4px;
                    cursor:pointer;
                    font-weight:bold;
                "
            >Finalizar</button>

        </div>
    </div>
</div>

<script>
let formAlvo = null;

function abrirModal(id) {
    formAlvo = document.getElementById("formFinalizar" + id);
    document.getElementById("modalConfirmacao").style.display = "flex";
}

function fecharModal() {
    document.getElementById("modalConfirmacao").style.display = "none";
}

document.getElementById("btnConfirmarModal").onclick = function () {
    if (formAlvo) {
        formAlvo.submit();
    }
};
</script>

<script>
(function(){
  const cores = {
    pardo: '#cc6600',
    verde: '#ccff33',
    preto: '#0A1A2F',
    roxo:  '#8e44ad'
  };

  function detectTema() {
    const html = document.documentElement;
    if (html.dataset.theme === 'dark') return 'dark';
    if (html.dataset.theme === 'light') return 'light';

    if (localStorage.getItem('theme') === 'dark') return 'dark';
    if (localStorage.getItem('theme') === 'light') return 'light';

    return window.matchMedia('(prefers-color-scheme: dark)').matches
           ? 'dark'
           : 'light';
  }

  function setupButton(btn) {
    function apply(tema) {
      if (tema === 'dark') {
        btn.style.backgroundColor = cores.roxo;
        btn.style.color = '#fff';
        btn.style.borderColor = '#fff';
      } else {
        btn.style.backgroundColor = cores.verde;
        btn.style.color = cores.pardo;
        btn.style.borderColor = cores.pardo;
      }
    }

    function onEnter() {
      const tema = detectTema();
      if (tema === 'dark') {
        btn.style.backgroundColor = cores.verde;
        btn.style.color = cores.pardo;
        btn.style.borderColor = cores.pardo;
      } else {
        btn.style.backgroundColor = cores.roxo;
        btn.style.color = '#fff';
        btn.style.borderColor = cores.pardo;
      }
    }

    function onLeave() {
      apply(detectTema());
    }

    btn.__enterHandler && btn.removeEventListener('mouseenter', btn.__enterHandler);
    btn.__leaveHandler && btn.removeEventListener('mouseleave', btn.__leaveHandler);

    btn.__enterHandler = onEnter;
    btn.__leaveHandler = onLeave;

    btn.addEventListener('mouseenter', onEnter);
    btn.addEventListener('mouseleave', onLeave);

    apply(detectTema());
  }

  function setupAll() {
    document.querySelectorAll('.btn-finalizar').forEach(setupButton);
  }

  const mo = new MutationObserver(() => setupAll());
  mo.observe(document.body, { childList: true, subtree: true });

  const moClass = new MutationObserver(() => setupAll());
  moClass.observe(document.body, { attributes: true, attributeFilter: ['class'] });

  window.addEventListener('storage', e => { if (e.key === 'theme') setupAll(); });

  document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', setupAll)
    : setupAll();

})();
</script>






                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7">Nenhum chamado aberto.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </section>

    <section class="card">
        <h2>Chamados finalizados</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuário</th>
                    <th>Cultivar</th>
                    <th>Quantidade</th>
                    <th>Observações</th>
                    <th>Criada em</th>
                    <th>Finalizado em</th>
                </tr>
            </thead>
            <tbody>
                {% if finalizados and finalizados|length > 0 %}
                    {% for o in finalizados %}
                        <tr>
                            <td>{{ o.id }}</td>
                            <td>{{ o.solicitante.username }}</td>
                            <td>{{ o.cultivar.nome }}{% if o.cultivar.especie %} - {{ o.cultivar.especie }}{% endif %}</td>
                            <td>{{ o.quantidade or '-' }}</td>
                            <td>{{ o.descricao or '-' }}</td>
                            <td>{{ o.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ o.data_finalizacao.strftime('%d/%m/%Y %H:%M') if o.data_finalizacao else '-' }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7">Nenhum chamado finalizado.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </section>

    <!-- SCRIPT: sincroniza barra/botões com o tema e integra com os botões de configuração -->
    <script>
    (function() {
      // Aplica estilos da barra e botões conforme o estado atual de body.dark-mode
      function applyThemeToBar() {
        const barra = document.querySelector('.barra');
        if (!barra) return;
        const botoes = barra.querySelectorAll('.botao');
        const isDark = document.body.classList.contains('dark-mode');

        if (isDark) {
          barra.style.backgroundColor = '#1D3E5E';
          barra.style.border = '3px solid #fff';
          botoes.forEach(btn => {
            btn.style.backgroundColor = '#8e44ad';
            btn.style.border = '3px solid #fff';
            btn.style.color = '#fff';
            btn.onmouseover = function () {
              this.style.backgroundColor = '#ccff33';
              this.style.color = '#cc6600';
              this.style.borderColor = '#cc6600';
            };
            btn.onmouseout = function () {
              this.style.backgroundColor = '#8e44ad';
              this.style.color = '#fff';
              this.style.borderColor = '#fff';
            };
          });
        } else {
          barra.style.backgroundColor = '#F0FFF0';
          barra.style.border = '3px solid #cc6600';
          botoes.forEach(btn => {
            btn.style.backgroundColor = '#ccff33';
            btn.style.border = '3px solid #cc6600';
            btn.style.color = '#cc6600';
            btn.onmouseover = function () {
              this.style.backgroundColor = '#8e44ad';
              this.style.color = '#fff';
              this.style.borderColor = '#cc6600';
            };
            btn.onmouseout = function () {
              this.style.backgroundColor = '#ccff33';
              this.style.color = '#cc6600';
              this.style.borderColor = '#cc6600';
            };
          });
        }
      }

      // Observa mudanças na classe do body para reagir quando o tema mudar em qualquer parte da app
      const observer = new MutationObserver(() => applyThemeToBar());
      observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

      // Integra com os botões de configuração do painel (lightMode/darkMode)
      function waitForSettingsButtons() {
        const light = document.getElementById('lightMode');
        const dark = document.getElementById('darkMode');
        if (light && dark) {
          // Reforça handlers: quando clicados, atualizam body e barra
          light.onclick = function() {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light');
            // Atualiza estado visual dos botões do painel
            light.classList.add('active');
            dark.classList.remove('active');
            applyThemeToBar();
          };
          dark.onclick = function() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
            dark.classList.add('active');
            light.classList.remove('active');
            applyThemeToBar();
          };

          // Aplica tema salvo imediatamente
          const saved = localStorage.getItem('theme') || 'light';
          if (saved === 'dark') {
            document.body.classList.add('dark-mode');
            dark.classList.add('active');
            light.classList.remove('active');
          } else {
            document.body.classList.remove('dark-mode');
            light.classList.add('active');
            dark.classList.remove('active');
          }
          applyThemeToBar();
          return true;
        }
        return false;
      }

     

      // Tenta encontrar os botões de configuração; se ainda não renderizaram, re-tenta
      function init() {
        if (!waitForSettingsButtons()) {
          const retry = setInterval(() => {
            if (waitForSettingsButtons()) clearInterval(retry);
          }, 150);
          // Fallback: aplica tema salvo mesmo antes dos botões existirem
          const saved = localStorage.getItem('theme') || 'light';
          if (saved === 'dark') document.body.classList.add('dark-mode');
          else document.body.classList.remove('dark-mode');
          applyThemeToBar();
        }
      }

      // Inicializa ao carregar
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();

    document.addEventListener('DOMContentLoaded', function() {
    const menuIcon = document.getElementById('menu-icon');
    if (document.body.classList.contains('dark-mode')) {
        menuIcon.style.color = '#fff';
    } else {
        menuIcon.style.color = '#cc6600';
    }
    
    // Observa mudanças de tema
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                if (document.body.classList.contains('dark-mode')) {
                    menuIcon.style.color = '#fff';
                } else {
                    menuIcon.style.color = '#cc6600';
                }
            }
        });
    });
    observer.observe(document.body, { attributes: true });
});
    </script>
{% endblock %}