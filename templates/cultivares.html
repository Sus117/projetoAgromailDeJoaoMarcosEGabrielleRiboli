{% extends 'base.html' %}
{% block title %}Cultivares — Ordens de Serviço{% endblock %}
{% block content %}

<!-- BARRA ENTRE NAVBAR E O CONTEÚDO -->
<div class="barra"
     style="
       width: 81%;
       background-color: #F0FFF0;
       border: 3px solid #cc6600;
       border-radius: 8px;
       padding: 10px;
       display: flex;
       justify-content: center;
       gap: 20px;
       margin-bottom: 15px;
       margin-top: 15px;
       margin-left: auto;          /* centraliza */
       margin-right: auto;         /* centraliza */
     ">

       <!-- ÍCONE DE MENU (lado esquerdo) -->
  <!-- ÍCONE DE MENU (lado esquerdo) -->
<a title="Clique neste botão para voltar a tela de seleção" href="{{ url_for('index') }}" 
   id="menu-icon"
   title="Este botão retorna a tela primária"
   style="
     display: inline-block;
     background-color: transparent;
     border: none;
     font-size: 35px;
     color: #cc6600;
     text-decoration: none;
     margin-left: 25px;
     cursor: pointer;
     transition: 0.2s;
     font-weight: bold;
   "
   onmouseover="this.style.color = document.body.classList.contains('dark-mode') ? '#cc6600' : '#cc6600'"
   onmouseout="this.style.color = document.body.classList.contains('dark-mode') ? '#fff' : '#cc6600'">
  <i class="fa fa-bars"></i>
</a>
  
  <!-- FECHAMENTO DO LINK DO MENU -->

  <!-- BOTÃO 1 -->
  <a title="Clique para ir á página cadastrar cultivares" href="{{ url_for('cultivares') }}" class="botao"
     style="
       display: inline-block;
       background-color: #ccff33;
       border: 3px solid #cc6600;
       padding: 10px 20px;
       font-size: 19px;
       border-radius: 8px;
       text-decoration: none;
       color: #cc6600;
       transition: 0.2s;
     ">
    Cadastrar Cultivares
  </a>

  <!-- BOTÃO 2 -->
  <a title="Clique para ir á página vizualizar ordens de serviços" href="{{ url_for('ordens_todas') }}" class="botao"
     style="
       display: inline-block;
       background-color: #ccff33;
       border: 3px solid #cc6600;
       padding: 10px 20px;
       font-size: 19px;
       border-radius: 8px;
       text-decoration: none;
       color: #cc6600;
       transition: 0.2s;
     ">
    Vizualizar Ordens de Serviços de Todos
  </a>

</div>


<!-- RESTANTE DO SEU CÓDIGO -->
<section class="card">
  <h1>Cadastrar Cultivar</h1>
  <form class="form" method="post" action="{{ url_for('cultivares') }}">
    <div class="form-row">
      <label for="nome">Nome do Cultivar</label>
      <input type="text" id="nome" name="nome" required />
    </div>
    <div class="form-row">
      <label for="especie">Espécie ou Variedade</label>
      <input type="text" id="especie" name="especie" />
    </div>


<div title="Você deseja salvar este cultivar" class="form-actions">
  <button type="button" class="btn-salvar"
      style="
        padding: 10px 419px;
        border-radius: 6px;
        font-size: 11.8px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.15s;
        border: 4px solid;
      ">
      Salvar Cultivar
  </button>
</div>

<!-- MODAL -->
<div id="modalSalvar" style="
     display: none;
     position: fixed;
     top: 0; left: 0;
     width: 100%; height: 100%;
     background: rgba(0,0,0,0.5);
     justify-content: center;
     align-items: center;
     z-index: 9999;
  ">
  <div id="modalContent" style="
       background: #fff;
       padding: 18px;
       border-radius: 8px;
       border: 2.5px solid #cc6600;
       width: 320px;
       text-align: center;
  ">
    <h3 style="margin-bottom:10px;">Confirmar ação</h3>
    <p style="margin-bottom:14px;">Você realmente quer salvar este cultivar?</p>

    <div style="display:flex; justify-content:space-around;">
      <button type="button" id="cancelSalvar" style="
          padding:6px 14px;
          border-radius:4px;
          cursor:pointer;
        ">Cancelar</button>

      <button type="button" id="confirmSalvar" style="
          padding:6px 14px;
          border-radius:4px;
          cursor:pointer;
          font-weight:bold;
        ">Salvar</button>
    </div>
  </div>
</div>

<script>
(function(){
  // CORES
  const cores = {
    pardo:  '#CC6600',
    verde:  '#CCFF33',
    branco: '#FFFFFF',
    roxo:   '#8e44ad',
    preto:  '#0F1C34'
  };

  // DETECTAR TEMA
  function detectTema() {
    if (localStorage.getItem("theme")) return localStorage.getItem("theme");
    if (document.documentElement.dataset.theme) return document.documentElement.dataset.theme;
    if (document.body.classList.contains("dark-mode")) return "dark";
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }

  // APLICAR ESTILOS COM HOVER
  function aplicarHovers() {
    const tema = detectTema();
    
    // BOTÃO PRINCIPAL
    document.querySelectorAll('.btn-salvar').forEach(btn => {
      // Remover eventos anteriores
      btn.onmouseenter = null;
      btn.onmouseleave = null;
      
      // Estado normal
      if (tema === 'dark') {
        btn.style.background = cores.roxo;
        btn.style.color = cores.branco;
        btn.style.borderColor = cores.branco;
      } else {
        btn.style.background = cores.verde;
        btn.style.color = cores.pardo;
        btn.style.borderColor = cores.pardo;
      }
      
      // Hover
      btn.addEventListener('mouseenter', function() {
        if (tema === 'dark') {
          this.style.background = cores.verde;
          this.style.color = cores.pardo;
          this.style.borderColor = cores.pardo;
        } else {
          this.style.background = cores.roxo;
          this.style.color = cores.branco;
          this.style.borderColor = cores.pardo;
        }
      });
      
      btn.addEventListener('mouseleave', function() {
        aplicarHovers();
      });
    });
    
    // MODAL
    const modalContent = document.getElementById('modalContent');
    const cancelBtn = document.getElementById('cancelSalvar');
    const confirmBtn = document.getElementById('confirmSalvar');
    
    if (modalContent) {
      if (tema === 'dark') {
        modalContent.style.background = cores.preto;
        modalContent.style.color = cores.branco;
        modalContent.style.borderColor = cores.branco;
      } else {
        modalContent.style.background = cores.branco;
        modalContent.style.color = '#000';
        modalContent.style.borderColor = cores.pardo;
      }
    }
    
    if (cancelBtn) {
      if (tema === 'dark') {
        cancelBtn.style.background = '#555';
        cancelBtn.style.color = '#fff';
        cancelBtn.style.border = '2px solid #888';
      } else {
        cancelBtn.style.background = '#ccc';
        cancelBtn.style.color = '#000';
        cancelBtn.style.border = '2px solid #777';
      }
      
      // Hover simples para cancelar
      cancelBtn.onmouseenter = () => cancelBtn.style.opacity = '0.85';
      cancelBtn.onmouseleave = () => cancelBtn.style.opacity = '1';
    }
    
    if (confirmBtn) {
      // Remover eventos anteriores
      confirmBtn.onmouseenter = null;
      confirmBtn.onmouseleave = null;
      
      // Estado normal
      if (tema === 'dark') {
        confirmBtn.style.background = cores.roxo;
        confirmBtn.style.color = cores.branco;
        confirmBtn.style.border = '2px solid ' + cores.branco;
      } else {
        confirmBtn.style.background = cores.verde;
        confirmBtn.style.color = cores.pardo;
        confirmBtn.style.border = '2px solid ' + cores.pardo;
      }
      
      // Hover
      confirmBtn.addEventListener('mouseenter', function() {
        if (tema === 'dark') {
          this.style.background = cores.verde;
          this.style.color = cores.pardo;
          this.style.borderColor = cores.pardo;
        } else {
          this.style.background = cores.roxo;
          this.style.color = cores.branco;
          this.style.borderColor = cores.pardo;
        }
      });
      
      confirmBtn.addEventListener('mouseleave', function() {
        aplicarHovers();
      });
    }
  }

  // FUNCIONALIDADE DO MODAL
  const modal = document.getElementById('modalSalvar');
  let formAlvo = null;

  function abrirModal(form) {
    formAlvo = form;
    modal.style.display = 'flex';
    aplicarHovers();
  }

  function fecharModal() {
    modal.style.display = 'none';
    formAlvo = null;
  }

  // CONFIGURAR EVENTOS
  function configurarEventos() {
    // Botão principal
    document.querySelectorAll('.btn-salvar').forEach(btn => {
      btn.onclick = () => {
        const form = btn.closest('form') || document.querySelector('form');
        abrirModal(form);
      };
    });
    
    // Botões do modal
    document.getElementById('cancelSalvar').onclick = fecharModal;
    document.getElementById('confirmSalvar').onclick = () => {
      if (formAlvo) formAlvo.submit();
    };
    
    // Fechar modal clicando fora
    modal.onclick = (e) => {
      if (e.target === modal) fecharModal();
    };
  }

  // INICIAR
  function iniciar() {
    aplicarHovers();
    configurarEventos();
  }

  // Quando o DOM carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', iniciar);
  } else {
    iniciar();
  }

  // Observar mudanças de tema
  const observer = new MutationObserver(() => {
    aplicarHovers();
  });
  
  observer.observe(document.documentElement, { 
    attributes: true, 
    attributeFilter: ['class', 'data-theme'] 
  });
  
  observer.observe(document.body, { 
    attributes: true, 
    attributeFilter: ['class'] 
  });

  // Atualizar quando o tema mudar no localStorage
  window.addEventListener('storage', (e) => {
    if (e.key === 'theme') {
      aplicarHovers();
    }
  });

})();
</script>


   <button
    title="Clique para limpar os campos"
    type="reset"
    class="button secondary">
    Limpar
</button>





    </div>
  </form>
  <p class="muted">Preencha e salve para cadastrar.</p>
</section>

<section class="card">
  <h2>Cultivares cadastrados</h2>
  <table class="table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Espécie/Variedade</th>
      </tr>
    </thead>
    <tbody>
      {% if cultivares and cultivares|length > 0 %}
        {% for c in cultivares %}
          <tr>
            <td>{{ c.nome }}</td>
            <td>{{ c.especie or '-' }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="2">Nenhum cultivar cadastrado.</td></tr>
      {% endif %}
    </tbody>
  </table>
</section>

<!-- SCRIPT: sincroniza barra/botões com o tema e integra com os botões de configuração -->
<script>
(function() {
  // Aplica estilos da barra e botões conforme o estado atual de body.dark-mode
  function applyThemeToBar() {
    const barra = document.querySelector('.barra');
    if (!barra) return;
    const botoes = barra.querySelectorAll('.botao');
    const isDark = document.body.classList.contains('dark-mode');

    if (isDark) {
      barra.style.backgroundColor = '#1D3E5E';
      barra.style.border = '3px solid #fff';
      botoes.forEach(btn => {
        btn.style.backgroundColor = '#8e44ad';
        btn.style.border = '3px solid #fff';
        btn.style.color = '#fff';
        btn.onmouseover = function () {
          this.style.backgroundColor = '#ccff33';
          this.style.color = '#cc6600';
          this.style.borderColor = '#cc6600';
        };
        btn.onmouseout = function () {
          this.style.backgroundColor = '#8e44ad';
          this.style.color = '#fff';
          this.style.borderColor = '#fff';
        };
      });
    } else {
      barra.style.backgroundColor = '#F0FFF0';
      barra.style.border = '3px solid #cc6600';
      botoes.forEach(btn => {
        btn.style.backgroundColor = '#ccff33';
        btn.style.border = '3px solid #cc6600';
        btn.style.color = '#cc6600';
        btn.onmouseover = function () {
          this.style.backgroundColor = '#8e44ad';
          this.style.color = '#fff';
          this.style.borderColor = '#cc6600';
        };
        btn.onmouseout = function () {
          this.style.backgroundColor = '#ccff33';
          this.style.color = '#cc6600';
          this.style.borderColor = '#cc6600';
        };
      });
    }
  }

  // Observa mudanças na classe do body para reagir quando o tema mudar em qualquer parte da app
  const observer = new MutationObserver(() => applyThemeToBar());
  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });

  // Integra com os botões de configuração do painel (lightMode/darkMode)
  function waitForSettingsButtons() {
    const light = document.getElementById('lightMode');
    const dark = document.getElementById('darkMode');
    if (light && dark) {
      // Reforça handlers: quando clicados, atualizam body e barra
      light.onclick = function() {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        // Atualiza estado visual dos botões do painel
        light.classList.add('active');
        dark.classList.remove('active');
        applyThemeToBar();
      };
      dark.onclick = function() {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        dark.classList.add('active');
        light.classList.remove('active');
        applyThemeToBar();
      };

      // Aplica tema salvo imediatamente
      const saved = localStorage.getItem('theme') || 'light';
      if (saved === 'dark') {
        document.body.classList.add('dark-mode');
        dark.classList.add('active');
        light.classList.remove('active');
      } else {
        document.body.classList.remove('dark-mode');
        light.classList.add('active');
        dark.classList.remove('active');
      }
      applyThemeToBar();
      return true;
    }
    return false;
  }

  // Tenta encontrar os botões de configuração; se ainda não renderizaram, re-tenta
  function init() {
    if (!waitForSettingsButtons()) {
      const retry = setInterval(() => {
        if (waitForSettingsButtons()) clearInterval(retry);
      }, 150);
      // Fallback: aplica tema salvo mesmo antes dos botões existirem
      const saved = localStorage.getItem('theme') || 'light';
      if (saved === 'dark') document.body.classList.add('dark-mode');
      else document.body.classList.remove('dark-mode');
      applyThemeToBar();
    }
  }

  // Inicializa ao carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

document.addEventListener('DOMContentLoaded', function() {
    const menuIcon = document.getElementById('menu-icon');
    if (document.body.classList.contains('dark-mode')) {
        menuIcon.style.color = '#fff';
    } else {
        menuIcon.style.color = '#cc6600';
    }
    
    // Observa mudanças de tema
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                if (document.body.classList.contains('dark-mode')) {
                    menuIcon.style.color = '#fff';
                } else {
                    menuIcon.style.color = '#cc6600';
                }
            }
        });
    });
    observer.observe(document.body, { attributes: true });
});
</script>

{% endblock %}
